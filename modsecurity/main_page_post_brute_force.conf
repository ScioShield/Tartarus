# Step 1: Track failed login attempts in responses
SecRule RESPONSE_BODY "Login failed" \
    "id:1000001,\
    phase:4,\
    t:none,\
    capture,\
    msg:'Failed login detected in response',\
    tag:'login-bruteforce',\
    severity:'WARNING',\
    ver:'OWASP_CRS/BruteForce-Login',\
    setvar:ip.failed_login_counter=+1,\
    expirevar:ip.failed_login_counter=60"

# Step 2: Block or alert if too many failures occur from the same IP
SecRule IP:failed_login_counter "@gt 5" \
    "id:1000002,\
    phase:1,\
    t:none,\
    msg:'Potential brute-force attack detected',\
    tag:'login-bruteforce',\
    severity:'CRITICAL',\
    ver:'OWASP_CRS/BruteForce-Login',\
    deny,\
    log
    "
